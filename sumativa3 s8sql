
-- USUARIO: ADMIN/SYS/SYSTEM 


-- 1. Crear usuarios
CREATE USER PRY2205_USER1 IDENTIFIED BY "User1Pass123";
CREATE USER PRY2205_USER2 IDENTIFIED BY "User2Pass456";

-- 2. Otorgar privilegios básicos de conexión y recursos
GRANT CREATE SESSION TO PRY2205_USER1, PRY2205_USER2;
GRANT RESOURCE TO PRY2205_USER1, PRY2205_USER2;

-- 3. Crear roles
CREATE ROLE PRY2205_ROL_D;
CREATE ROLE PRY2205_ROL_P;

-- 4. Asignar privilegios al rol PRY2205_ROL_D (para PRY2205_USER1)
GRANT CREATE TABLE, CREATE INDEX, CREATE VIEW, CREATE SEQUENCE, 
      CREATE TRIGGER, CREATE SYNONYM TO PRY2205_ROL_D;

-- 5. Asignar privilegios al rol PRY2205_ROL_P (para PRY2205_USER2)
GRANT CREATE TABLE, CREATE SEQUENCE, CREATE TRIGGER TO PRY2205_ROL_P;

-- 6. Asignar roles a usuarios
GRANT PRY2205_ROL_D TO PRY2205_USER1;
GRANT PRY2205_ROL_P TO PRY2205_USER2;

-- 7. Otorgar cuota de tablespace
ALTER USER PRY2205_USER1 QUOTA UNLIMITED ON USERS;
ALTER USER PRY2205_USER2 QUOTA UNLIMITED ON USERS;

-- 8. Permitir a PRY2205_USER2 crear sinónimos privados sobre objetos de PRY2205_USER1
GRANT CREATE ANY SYNONYM TO PRY2205_USER2;


-- USUARIO: PRY2205_USER1 (Owner de las tablas)


--Crear sinónimos privados para los objetos
CREATE OR REPLACE SYNONYM SYN_PRESTAMO FOR PRESTAMO;
CREATE OR REPLACE SYNONYM SYN_ALUMNO FOR ALUMNO;
CREATE OR REPLACE SYNONYM SYN_CARRERA FOR CARRERA;
CREATE OR REPLACE SYNONYM SYN_ESCUELA FOR ESCUELA;
CREATE OR REPLACE SYNONYM SYN_REBAJA_MULTA FOR REBAJA_MULTA;
CREATE OR REPLACE SYNONYM SYN_EMPLEADO FOR EMPLEADO;
CREATE OR REPLACE SYNONYM SYN_EJEMPLAR FOR EJEMPLAR;
CREATE OR REPLACE SYNONYM SYN_LIBRO FOR LIBRO;
CREATE OR REPLACE SYNONYM SYN_AUTOR FOR AUTOR;
CREATE OR REPLACE SYNONYM SYN_EDITORIAL FOR EDITORIAL;

-- Crear sinónimos públicos para que PRY2205_USER2 pueda acceder
CREATE OR REPLACE PUBLIC SYNONYM PUB_PRESTAMO FOR PRY2205_USER1.PRESTAMO;
CREATE OR REPLACE PUBLIC SYNONYM PUB_ALUMNO FOR PRY2205_USER1.ALUMNO;
CREATE OR REPLACE PUBLIC SYNONYM PUB_CARRERA FOR PRY2205_USER1.CARRERA;
CREATE OR REPLACE PUBLIC SYNONYM PUB_EMPLEADO FOR PRY2205_USER1.EMPLEADO;
CREATE OR REPLACE PUBLIC SYNONYM PUB_EJEMPLAR FOR PRY2205_USER1.EJEMPLAR;
CREATE OR REPLACE PUBLIC SYNONYM PUB_LIBRO FOR PRY2205_USER1.LIBRO;
CREATE OR REPLACE PUBLIC SYNONYM PUB_REBAJA_MULTA FOR PRY2205_USER1.REBAJA_MULTA;

--Otorgar permisos de SELECT a PRY2205_USER2 sobre las tablas necesarias
GRANT SELECT ON PRESTAMO TO PRY2205_USER2;
GRANT SELECT ON ALUMNO TO PRY2205_USER2;
GRANT SELECT ON CARRERA TO PRY2205_USER2;
GRANT SELECT ON EMPLEADO TO PRY2205_USER2;
GRANT SELECT ON EJEMPLAR TO PRY2205_USER2;
GRANT SELECT ON LIBRO TO PRY2205_USER2;
GRANT SELECT ON REBAJA_MULTA TO PRY2205_USER2;


-- USUARIO: PRY2205_USER2 (Usuario genérico)


-- 1. Crear sinónimos privados para acceder a las tablas de PRY2205_USER1
CREATE OR REPLACE SYNONYM PRIV_PRESTAMO FOR PRY2205_USER1.PRESTAMO;
CREATE OR REPLACE SYNONYM PRIV_ALUMNO FOR PRY2205_USER1.ALUMNO;
CREATE OR REPLACE SYNONYM PRIV_CARRERA FOR PRY2205_USER1.CARRERA;
CREATE OR REPLACE SYNONYM PRIV_EMPLEADO FOR PRY2205_USER1.EMPLEADO;
CREATE OR REPLACE SYNONYM PRIV_EJEMPLAR FOR PRY2205_USER1.EJEMPLAR;
CREATE OR REPLACE SYNONYM PRIV_LIBRO FOR PRY2205_USER1.LIBRO;
CREATE OR REPLACE SYNONYM PRIV_REBAJA_MULTA FOR PRY2205_USER1.REBAJA_MULTA;



-- CASO 2: Creación de Informe de Control de Stock
-- USUARIO: PRY2205_USER2


-- Crear secuencia para el número correlativo
CREATE SEQUENCE SEQ_CONTROL_STOCK
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- Crear tabla CONTROL_STOCK_LIBROS
CREATE TABLE CONTROL_STOCK_LIBROS (
    ID_CONTROL NUMBER PRIMARY KEY,
    LIBRO_ID NUMBER,
    NOMBRE_LIBRO VARCHAR2(70),
    TOTAL_EJEMPLARES NUMBER,
    EN_PRESTAMO NUMBER,
    DISPONIBLES NUMBER,
    PORCENTAJE_PRESTAMO VARCHAR2(10),
    STOCK_CRITICO CHAR(1)
);

-- Insertar datos en la tabla usando consulta paramétrica
INSERT INTO CONTROL_STOCK_LIBROS (
    ID_CONTROL,
    LIBRO_ID,
    NOMBRE_LIBRO,
    TOTAL_EJEMPLARES,
    EN_PRESTAMO,
    DISPONIBLES,
    PORCENTAJE_PRESTAMO,
    STOCK_CRITICO
)
SELECT 
    SEQ_CONTROL_STOCK.NEXTVAL AS ID_CONTROL,
    l.LIBROID AS LIBRO_ID,
    l.NOMBRE_LIBRO,
    COUNT(e.EJEMPLARID) AS TOTAL_EJEMPLARES,
    COUNT(CASE WHEN p.PRESTAMOID IS NOT NULL AND p.FECHA_ENTREGA IS NULL THEN 1 END) AS EN_PRESTAMO,
    COUNT(e.EJEMPLARID) - COUNT(CASE WHEN p.PRESTAMOID IS NOT NULL AND p.FECHA_ENTREGA IS NULL THEN 1 END) AS DISPONIBLES,
    ROUND(
        (COUNT(CASE WHEN p.PRESTAMOID IS NOT NULL AND p.FECHA_ENTREGA IS NULL THEN 1 END) * 100.0) / 
        NULLIF(COUNT(e.EJEMPLARID), 0), 
        2
    ) || '%' AS PORCENTAJE_PRESTAMO,
    CASE 
        WHEN COUNT(e.EJEMPLARID) - COUNT(CASE WHEN p.PRESTAMOID IS NOT NULL AND p.FECHA_ENTREGA IS NULL THEN 1 END) > 2 
        THEN 'S' 
        ELSE 'N' 
    END AS STOCK_CRITICO
FROM 
    PRIV_LIBRO l
    JOIN PRIV_EJEMPLAR e ON l.LIBROID = e.LIBRO_LIBROID
    LEFT JOIN PRIV_PRESTAMO p ON e.EJEMPLARID = p.EJEMPLAR_EJEMPLARID 
        AND e.LIBRO_LIBROID = p.EJEMPLAR_LIBROID
        AND p.EMPLEADO_EMPLEADOID IN (190, 180, 150)
        AND EXTRACT(YEAR FROM p.FECHA_INICIO) = EXTRACT(YEAR FROM SYSDATE) - 2
        AND EXTRACT(MONTH FROM p.FECHA_INICIO) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -24))
WHERE 
    p.PRESTAMOID IS NULL 
    OR (p.EMPLEADO_EMPLEADOID IN (190, 180, 150) 
        AND EXTRACT(YEAR FROM p.FECHA_INICIO) = EXTRACT(YEAR FROM SYSDATE) - 2
        AND EXTRACT(MONTH FROM p.FECHA_INICIO) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -24)))
GROUP BY 
    l.LIBROID, l.NOMBRE_LIBRO
ORDER BY 
    l.LIBROID;

-- Verificar los datos insertados
SELECT * FROM CONTROL_STOCK_LIBROS ORDER BY LIBRO_ID;

--Crear índice para mejorar rendimiento de consultas
CREATE INDEX IDX_CTRL_STOCK_LIBRO ON CONTROL_STOCK_LIBROS(LIBRO_ID);


-- CASO 3.1: Creación de Vista VW_DETALLE_MULTAS
-- USUARIO: PRY2205_USER1


-- Crear vista de lectura para detalles de multas
CREATE OR REPLACE VIEW VW_DETALLE_MULTAS AS
SELECT 
    p.PRESTAMOID AS ID_PRESTAMO,
    a.NOMBRE || ' ' || a.APATERNO || ' ' || NVL(a.AMATERNO, '') AS NOMBRE_COMPLETO,
    c.DESCRIPCION AS NOMBRE_CARRERA,
    l.LIBROID AS CODIGO_LIBRO,
    l.PRECIO AS PRECIO_LIBRO,
    TO_CHAR(p.FECHA_TERMINO, 'DD/MM/YYYY') AS FECHA_DEVOLUCION,
    TO_CHAR(p.FECHA_ENTREGA, 'DD/MM/YYYY') AS FECHA_ENTREGA_REAL,
    GREATEST(0, TRUNC(p.FECHA_ENTREGA) - TRUNC(p.FECHA_TERMINO)) AS DIAS_ATRASO,
    ROUND(l.PRECIO * 0.03 * GREATEST(0, TRUNC(p.FECHA_ENTREGA) - TRUNC(p.FECHA_TERMINO)), 0) AS MULTA_BASE,
    CASE 
        WHEN c.DESCRIPCION LIKE '%Prevención de Riesgos%' 
             OR c.DESCRIPCION LIKE '%Gastronomía%'
             OR c.DESCRIPCION LIKE '%Publicidad%'
             OR c.DESCRIPCION LIKE '%Diseño Industrial%'
        THEN NVL(rm.PORC_REBAJA_MULTA, 0)
        ELSE 0
    END AS PORC_REBAJA,
    ROUND(
        l.PRECIO * 0.03 * GREATEST(0, TRUNC(p.FECHA_ENTREGA) - TRUNC(p.FECHA_TERMINO)) * 
        (1 - CASE 
                WHEN c.DESCRIPCION LIKE '%Prevención de Riesgos%' 
                     OR c.DESCRIPCION LIKE '%Gastronomía%'
                     OR c.DESCRIPCION LIKE '%Publicidad%'
                     OR c.DESCRIPCION LIKE '%Diseño Industrial%'
                THEN NVL(rm.PORC_REBAJA_MULTA, 0) / 100.0
                ELSE 0
             END
        ), 
        0
    ) AS MULTA_FINAL
FROM 
    SYN_PRESTAMO p
    JOIN SYN_ALUMNO a ON p.ALUMNO_ALUMNOID = a.ALUMNOID
    JOIN SYN_CARRERA c ON a.CARRERA_CARRERAID = c.CARRERAID
    JOIN SYN_EJEMPLAR e ON p.EJEMPLAR_EJEMPLARID = e.EJEMPLARID AND p.EJEMPLAR_LIBROID = e.LIBRO_LIBROID
    JOIN SYN_LIBRO l ON e.LIBRO_LIBROID = l.LIBROID
    LEFT JOIN SYN_REBAJA_MULTA rm ON c.CARRERAID = rm.CARRERA_CARRERAID
WHERE 
    EXTRACT(YEAR FROM p.FECHA_TERMINO) = EXTRACT(YEAR FROM SYSDATE) - 2
    AND p.FECHA_ENTREGA > p.FECHA_TERMINO
    AND p.FECHA_ENTREGA IS NOT NULL
ORDER BY 
    p.FECHA_ENTREGA DESC;

--Otorgar permisos de SELECT sobre la vista a PRY2205_USER2
GRANT SELECT ON VW_DETALLE_MULTAS TO PRY2205_USER2;

--Crear sinónimo público para la vista
CREATE OR REPLACE PUBLIC SYNONYM PUB_VW_DETALLE_MULTAS FOR PRY2205_USER1.VW_DETALLE_MULTAS;


-- CASO 3.2: Creación de Índices para Optimización
-- USUARIO: PRY2205_USER1


--Analizar el plan de ejecución de la vista
EXPLAIN PLAN FOR
SELECT * FROM VW_DETALLE_MULTAS;

--Ver el plan de ejecución
SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);

--Crear índices basados en el análisis del plan de ejecución

-- Índice para mejorar JOIN en tabla PRESTAMO
CREATE INDEX IDX_PRESTAMO_FECHAS ON PRESTAMO(FECHA_TERMINO, FECHA_ENTREGA, ALUMNO_ALUMNOID);

-- Índice para mejorar JOIN en tabla ALUMNO
CREATE INDEX IDX_ALUMNO_CARRERA ON ALUMNO(ALUMNOID, CARRERA_CARRERAID);

-- Índice para mejorar JOIN en tabla CARRERA
CREATE INDEX IDX_CARRERA_DESCRIPCION ON CARRERA(CARRERAID, DESCRIPCION);

-- Índice para mejorar JOIN en tabla EJEMPLAR
CREATE INDEX IDX_EJEMPLAR_LIBRO ON EJEMPLAR(EJEMPLARID, LIBRO_LIBROID);

-- Índice para mejorar JOIN en tabla LIBRO
CREATE INDEX IDX_LIBRO_PRECIO ON LIBRO(LIBROID, PRECIO);

-- Índice para tabla REBAJA_MULTA
CREATE INDEX IDX_REBAJA_CARRERA ON REBAJA_MULTA(CARRERA_CARRERAID);

--Verificar índices creados
SELECT index_name, table_name, uniqueness 
FROM user_indexes 
WHERE table_name IN ('PRESTAMO', 'ALUMNO', 'CARRERA', 'EJEMPLAR', 'LIBRO', 'REBAJA_MULTA')
ORDER BY table_name;

--Volver a analizar el plan de ejecución después de crear índices
EXPLAIN PLAN FOR
SELECT * FROM VW_DETALLE_MULTAS;

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);



-- PRUEBAS DE ACCESO Y FUNCIONALIDAD
-- USUARIO: PRY2205_USER2


--Verificar acceso a sinónimos
SELECT COUNT(*) FROM PRIV_PRESTAMO;
SELECT COUNT(*) FROM PRIV_ALUMNO;
SELECT COUNT(*) FROM PRIV_CARRERA;

--Consultar la vista creada por PRY2205_USER1
SELECT * FROM PRY2205_USER1.VW_DETALLE_MULTAS WHERE ROWNUM <= 10;

--Verificar tabla de control de stock
SELECT * FROM CONTROL_STOCK_LIBROS ORDER BY ID_CONTROL;

--Probar consulta paramétrica con fechas dinámicas
SELECT 
    EXTRACT(YEAR FROM SYSDATE) AS ANIO_ACTUAL,
    EXTRACT(YEAR FROM SYSDATE) - 2 AS ANIO_PROCESO,
    EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -24)) AS MES_PROCESO
FROM DUAL;